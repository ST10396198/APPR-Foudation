@model IEnumerable<APPR_Foudation.Models.VolunteerTask>

@{
    ViewData["Title"] = "Available Volunteer Tasks";
}

<div class="d-flex justify-content-between align-items-center mb-4">
    <h2>Available Volunteer Tasks</h2>
    <div>
        <a href="@Url.Action("AddSampleTasks", "Volunteer")" class="btn btn-outline-info btn-sm me-2">
            <i class="fas fa-plus me-1"></i>Add Sample Tasks
        </a>
        <a href="@Url.Action("MyTasks", "Volunteer")" class="btn btn-outline-primary">
            <i class="fas fa-clipboard-list me-1"></i>My Tasks
        </a>
    </div>
</div>

@if (TempData["SuccessMessage"] != null)
{
    <div class="alert alert-success">
        @TempData["SuccessMessage"]
    </div>
}

@if (TempData["ErrorMessage"] != null)
{
    <div class="alert alert-danger">
        @TempData["ErrorMessage"]
    </div>
}

@if (!Model.Any())
{
    <div class="alert alert-info text-center">
        <h4>No available tasks at the moment.</h4>
        <p>Please check back later for new volunteer opportunities.</p>
        <a href="@Url.Action("AddSampleTasks", "Volunteer")" class="btn btn-primary mt-2">
            Add Sample Tasks for Testing
        </a>
    </div>
}
else
{
    <div class="row">
        @foreach (var task in Model)
        {
            <div class="col-md-6 mb-4">
                <div class="card h-100 shadow-sm">
                    <div class="card-header">
                        <div class="d-flex justify-content-between align-items-start">
                            <h5 class="card-title mb-1">@task.Title</h5>
                            <div class="text-end">
                                <span class="badge bg-primary mb-1">@task.Type</span>
                                <span class="badge bg-@(task.Status == APPR_Foudation.Models.TaskStatus.Open ? "success" : "warning")">
                                    @task.Status
                                </span>
                            </div>
                        </div>
                    </div>
                    <div class="card-body">
                        <p class="card-text">@task.Description</p>
                        <div class="border-top pt-3">
                            <div class="row small text-muted">
                                <div class="col-12 mb-2">
                                    <i class="fas fa-map-marker-alt me-2"></i>
                                    <strong>Location:</strong> @task.Location
                                </div>
                                <div class="col-12 mb-2">
                                    <i class="fas fa-calendar me-2"></i>
                                    <strong>When:</strong> @task.StartDate.ToString("MMM dd, yyyy") - @task.EndDate.ToString("MMM dd, yyyy")
                                </div>
                                <div class="col-12">
                                    <i class="fas fa-users me-2"></i>
                                    <strong>Volunteers Needed:</strong>
                                    <span class="fw-bold">@task.CurrentVolunteers / @task.RequiredVolunteers</span>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="card-footer bg-transparent">
                        @if (task.Status == APPR_Foudation.Models.TaskStatus.Open && task.CurrentVolunteers < task.RequiredVolunteers)
                        {
                            <button class="btn btn-primary w-100 sign-up-btn" data-task-id="@task.TaskId">
                                <i class="fas fa-hand-paper me-2"></i>Sign Up for This Task
                            </button>
                        }
                        else
                        {
                            <button class="btn btn-secondary w-100" disabled>
                                <i class="fas fa-ban me-2"></i>
                                @(task.Status != APPR_Foudation.Models.TaskStatus.Open ? "Task Closed" : "Fully Booked")
                            </button>
                        }
                    </div>
                </div>
            </div>
        }
    </div>
}

<div class="mt-4">
    <a href="@Url.Action("Index", "Home")" class="btn btn-outline-secondary">
        <i class="fas fa-arrow-left me-2"></i>Back to Home
    </a>
</div>

@section Scripts {
    <script>
        $(document).ready(function() {
            $('.sign-up-btn').click(function() {
                var taskId = $(this).data('task-id');
                var button = $(this);

                // Show loading state
                button.prop('disabled', true).html('<i class="fas fa-spinner fa-spin me-2"></i>Signing Up...');

                $.ajax({
                    url: '@Url.Action("SignUpForTask", "Volunteer")',
                    type: 'POST',
                    data: { taskId: taskId },
                    headers: {
                        'RequestVerificationToken': $('input[name="__RequestVerificationToken"]').val()
                    },
                    success: function(response) {
                        if (response.success) {
                            // Show success message and update button
                            alert(response.message);
                            button.removeClass('btn-primary').addClass('btn-success')
                                .html('<i class="fas fa-check me-2"></i>Signed Up!');
                        } else {
                            // Show error message and reset button
                            alert(response.message);
                            button.prop('disabled', false)
                                .html('<i class="fas fa-hand-paper me-2"></i>Sign Up for This Task');
                        }
                    },
                    error: function() {
                        alert('An error occurred. Please try again.');
                        button.prop('disabled', false)
                            .html('<i class="fas fa-hand-paper me-2"></i>Sign Up for This Task');
                    }
                });
            });
        });
    </script>
}